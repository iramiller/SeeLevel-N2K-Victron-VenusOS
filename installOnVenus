#!/bin/sh

echo Installing GUI files and setting SeeLevelRepeater to run at startup

echo Preserving original GUI files
qmlDir=/opt/victronenergy/gui/qml

srcFile=$qmlDir/OverviewMobile.qml
destFile=$srcFile.orig
if [ -f "$destFile" ]; then
	echo $destFile exists - not changed
else
	echo $srcFile saved as $destFile
	cp $srcFile $destFile
fi

srcFile=$qmlDir/TileText.qml
destFile=$srcFile.orig
if [ -f "$destFile" ]; then
	echo $destFile exists - not changed
else
	echo $srcFile saved as $destFile
	cp $srcFile $destFile
fi

#single out version 2.33 and 2.60~19 for unique .qml files

version=`head -n 1 /opt/victronenergy/version`

echo Detected Venus $version

guiDir=/data/TankRepeater/GuiUpdates
if [ $version == 'v2.33' ]; then
    guiDir=$guiDir'2.33'
elif [ $version == 'v2.60~19' ]; then
    guiDir=$guiDir'2.60~19'
fi

echo Copying updated GUI files from $guiDir
cp $guiDir$guiDirExt/* $qmlDir

echo Starting repeater processes - ignore any errors reported
rm -f /service/SeeLevelRepeater
ps |grep See |grep -v grep|awk '{print $1}' | xargs kill

ln -s /data/TankRepeater/SeeLevelRepeater /service

echo Waiting 10 seconds for Repeater to start
sleep 10
echo Restarting GUI
killall gui

echo SeeLevel Repeater install complete

